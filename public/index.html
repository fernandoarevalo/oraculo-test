<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Or√°culo ‚Äî Lectura de Cartas</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400&family=Jost:wght@300;400;500&display=swap" rel="stylesheet"/>
<style>
  :root {
    --bg: #0c0c0e;
    --surface: #131318;
    --surface2: #1a1a22;
    --border: rgba(255,255,255,0.07);
    --gold: #c9a96e;
    --gold-light: #e8cfa0;
    --text: #e8e4dc;
    --text-dim: rgba(232,228,220,0.45);
    --accent: #7c6f9f;
    --radius: 16px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Jost', sans-serif;
    font-weight: 300;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 80% 50% at 50% -10%, rgba(124,111,159,0.12) 0%, transparent 70%),
      radial-gradient(ellipse 40% 30% at 80% 80%, rgba(201,169,110,0.06) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  .app {
    position: relative;
    z-index: 1;
    max-width: 680px;
    margin: 0 auto;
    padding: 0 24px 80px;
  }

  header {
    text-align: center;
    padding: 56px 0 48px;
  }

  .logo-symbol {
    width: 48px;
    height: 48px;
    margin: 0 auto 20px;
    opacity: 0.9;
  }

  header h1 {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(2rem, 6vw, 2.8rem);
    font-weight: 300;
    letter-spacing: 0.12em;
    color: var(--gold-light);
    line-height: 1.1;
  }

  header p {
    margin-top: 10px;
    font-size: 0.82rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--text-dim);
  }

  .progress-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-bottom: 40px;
  }

  .step-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--border);
    border: 1px solid rgba(255,255,255,0.15);
    transition: all 0.4s ease;
  }
  .step-dot.active { background: var(--gold); border-color: var(--gold); box-shadow: 0 0 8px rgba(201,169,110,0.5); }
  .step-dot.done   { background: rgba(201,169,110,0.35); border-color: rgba(201,169,110,0.35); }

  .step-line {
    flex: 1; max-width: 60px; height: 1px;
    background: var(--border);
    transition: background 0.4s ease;
  }
  .step-line.done { background: rgba(201,169,110,0.25); }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 32px;
    margin-bottom: 20px;
    animation: fadeUp 0.5s ease both;
  }

  @keyframes fadeUp {
    from { opacity:0; transform: translateY(16px); }
    to   { opacity:1; transform: translateY(0); }
  }

  .card-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.05rem;
    font-weight: 400;
    letter-spacing: 0.08em;
    color: var(--gold);
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .step-num {
    font-family: 'Jost', sans-serif;
    font-size: 0.65rem;
    font-weight: 500;
    letter-spacing: 0.15em;
    color: var(--text-dim);
    text-transform: uppercase;
  }

  .card-subtitle {
    font-size: 0.78rem;
    color: var(--text-dim);
    margin-bottom: 24px;
    line-height: 1.6;
  }

  .field { margin-bottom: 20px; }

  label {
    display: block;
    font-size: 0.72rem;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 8px;
  }

  input[type="text"],
  input[type="date"],
  textarea,
  select {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-family: 'Jost', sans-serif;
    font-size: 0.9rem;
    font-weight: 300;
    padding: 13px 16px;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    -webkit-appearance: none;
    appearance: none;
  }

  input:focus, textarea:focus, select:focus {
    border-color: rgba(201,169,110,0.45);
    box-shadow: 0 0 0 3px rgba(201,169,110,0.08);
  }

  textarea { resize: vertical; min-height: 90px; line-height: 1.6; }

  input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.4); cursor: pointer; }

  .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

  .photo-zone {
    border: 1.5px dashed rgba(201,169,110,0.25);
    border-radius: 12px;
    padding: 36px 24px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    background: var(--surface2);
  }
  .photo-zone:hover { border-color: rgba(201,169,110,0.5); background: rgba(201,169,110,0.04); }
  .photo-zone.has-image { padding: 0; border-style: solid; border-color: rgba(201,169,110,0.3); }

  .photo-zone input {
    position: absolute; inset: 0; opacity: 0;
    cursor: pointer; width: 100%; height: 100%;
  }

  .photo-icon { font-size: 2rem; margin-bottom: 12px; opacity: 0.6; }

  .photo-text { font-size: 0.82rem; color: var(--text-dim); line-height: 1.6; }
  .photo-text strong {
    display: block; font-weight: 400; color: var(--gold-light);
    font-size: 0.88rem; margin-bottom: 4px;
  }

  #preview-img { width: 100%; max-height: 320px; object-fit: cover; border-radius: 10px; display: none; }

  .photo-overlay {
    position: absolute; bottom: 0; left: 0; right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.7));
    padding: 20px 16px 14px;
    display: none; align-items: center; justify-content: center;
  }
  .photo-overlay span { font-size: 0.72rem; letter-spacing: 0.15em; text-transform: uppercase; color: rgba(255,255,255,0.6); }

  .camera-btn {
    display: inline-flex; align-items: center; gap: 8px;
    margin-top: 14px;
    background: transparent;
    border: 1px solid rgba(201,169,110,0.3);
    border-radius: 8px;
    color: var(--gold);
    font-family: 'Jost', sans-serif;
    font-size: 0.78rem; font-weight: 400;
    letter-spacing: 0.12em; text-transform: uppercase;
    padding: 9px 18px; cursor: pointer; transition: all 0.2s;
  }
  .camera-btn:hover { background: rgba(201,169,110,0.08); border-color: rgba(201,169,110,0.6); }

  .cards-detected { display: none; margin-top: 20px; animation: fadeUp 0.4s ease both; }
  .cards-detected .section-label {
    font-size: 0.68rem; letter-spacing: 0.2em;
    text-transform: uppercase; color: var(--text-dim); margin-bottom: 12px;
  }

  .card-chips { display: flex; flex-wrap: wrap; gap: 8px; }

  .chip {
    background: rgba(124,111,159,0.15);
    border: 1px solid rgba(124,111,159,0.3);
    border-radius: 20px; padding: 5px 14px;
    font-size: 0.78rem; color: rgba(200,190,220,0.9);
    letter-spacing: 0.05em;
    display: flex; align-items: center; gap: 6px;
    animation: chipIn 0.3s ease both;
  }
  @keyframes chipIn { from { opacity:0; transform: scale(0.85); } to { opacity:1; transform: scale(1); } }
  .chip span { opacity: 0.6; font-size: 0.7rem; }

  .analyzing-state { display: none; text-align: center; padding: 32px 0; animation: fadeUp 0.3s ease both; }

  .orb {
    width: 52px; height: 52px; margin: 0 auto 16px;
    border-radius: 50%;
    background: radial-gradient(circle at 35% 35%, rgba(201,169,110,0.4), rgba(124,111,159,0.2));
    border: 1px solid rgba(201,169,110,0.3);
    animation: pulse 1.8s ease-in-out infinite; position: relative;
  }
  .orb::after {
    content: ''; position: absolute; inset: -4px; border-radius: 50%;
    border: 1px solid rgba(201,169,110,0.12);
    animation: pulse 1.8s ease-in-out infinite 0.3s;
  }
  @keyframes pulse { 0%,100%{transform:scale(1);opacity:1;} 50%{transform:scale(1.1);opacity:0.7;} }

  .analyzing-text { font-family: 'Cormorant Garamond', serif; font-size: 1rem; color: var(--gold-light); letter-spacing: 0.08em; margin-bottom: 6px; }
  .analyzing-sub  { font-size: 0.75rem; color: var(--text-dim); letter-spacing: 0.1em; }

  .result-card {
    background: linear-gradient(135deg, #13131a, #191922);
    border: 1px solid rgba(201,169,110,0.2);
    border-radius: var(--radius); overflow: hidden;
    display: none; animation: fadeUp 0.6s ease both; margin-top: 20px;
  }

  .result-header {
    padding: 28px 32px 22px; border-bottom: 1px solid var(--border);
    display: flex; align-items: flex-start; gap: 16px;
  }
  .result-symbol { font-size: 1.6rem; line-height: 1; flex-shrink: 0; }
  .result-meta { flex: 1; }
  .result-name { font-family: 'Cormorant Garamond', serif; font-size: 1.2rem; font-weight: 400; color: var(--gold-light); margin-bottom: 3px; }
  .result-question { font-size: 0.78rem; color: var(--text-dim); font-style: italic; line-height: 1.5; }

  .result-body { padding: 28px 32px; }

  .result-cards-row { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 24px; }

  .result-chip {
    background: rgba(201,169,110,0.1);
    border: 1px solid rgba(201,169,110,0.22);
    border-radius: 4px; padding: 3px 10px;
    font-size: 0.72rem; letter-spacing: 0.08em; color: var(--gold);
  }

  .result-divider { height: 1px; background: var(--border); margin: 20px 0; }

  .interpretation {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.05rem; font-weight: 300;
    line-height: 1.85; color: rgba(232,228,220,0.88);
    white-space: pre-wrap;
  }

  .result-footer {
    padding: 16px 32px 24px;
    display: flex; justify-content: space-between;
    align-items: center; gap: 12px; flex-wrap: wrap;
  }
  .numerology-tag { font-size: 0.7rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-dim); }

  .btn {
    width: 100%; padding: 15px 24px;
    border-radius: 12px; border: none; cursor: pointer;
    font-family: 'Jost', sans-serif; font-size: 0.82rem;
    font-weight: 400; letter-spacing: 0.2em; text-transform: uppercase;
    transition: all 0.25s ease;
    display: flex; align-items: center; justify-content: center; gap: 10px;
  }
  .btn-primary { background: linear-gradient(135deg, #c9a96e, #b8935a); color: #0c0c0e; box-shadow: 0 4px 20px rgba(201,169,110,0.2); }
  .btn-primary:hover:not(:disabled) { background: linear-gradient(135deg, #d4b87c, #c9a96e); box-shadow: 0 6px 28px rgba(201,169,110,0.35); transform: translateY(-1px); }
  .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
  .btn-ghost { background: transparent; color: var(--text-dim); border: 1px solid var(--border); }
  .btn-ghost:hover { border-color: rgba(255,255,255,0.2); color: var(--text); }

  .btn-row { display: flex; gap: 12px; margin-top: 24px; }
  .btn-row .btn-ghost { flex: 0 0 auto; width: auto; padding: 15px 20px; }
  .btn-row .btn-primary { flex: 1; }

  .error-box {
    background: rgba(180,60,60,0.1); border: 1px solid rgba(180,60,60,0.25);
    border-radius: 10px; padding: 14px 16px;
    font-size: 0.82rem; color: rgba(255,180,170,0.9);
    display: none; margin-top: 16px; line-height: 1.5;
  }

  @media (max-width: 520px) {
    .card { padding: 24px 20px; }
    .row-2 { grid-template-columns: 1fr; }
    .result-body, .result-header, .result-footer { padding: 20px; }
    header { padding: 40px 0 36px; }
  }
</style>
</head>
<body>
<div class="app">

  <header>
    <svg class="logo-symbol" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="24" cy="24" r="22" stroke="#c9a96e" stroke-width="0.8" stroke-opacity="0.4"/>
      <circle cx="24" cy="24" r="15" stroke="#c9a96e" stroke-width="0.5" stroke-opacity="0.25"/>
      <path d="M24 4 L28 20 L44 24 L28 28 L24 44 L20 28 L4 24 L20 20 Z" fill="none" stroke="#c9a96e" stroke-width="0.8" stroke-linejoin="round" stroke-opacity="0.7"/>
      <circle cx="24" cy="24" r="3" fill="#c9a96e" fill-opacity="0.6"/>
    </svg>
    <h1>Or√°culo</h1>
    <p>Lectura personal de cartas</p>
  </header>

  <div class="progress-bar" id="progressBar">
    <div class="step-dot active" id="dot1"></div>
    <div class="step-line" id="line1"></div>
    <div class="step-dot" id="dot2"></div>
    <div class="step-line" id="line2"></div>
    <div class="step-dot" id="dot3"></div>
    <div class="step-line" id="line3"></div>
    <div class="step-dot" id="dot4"></div>
  </div>

  <!-- STEP 1 -->
  <div class="card" id="step1">
    <div class="card-title">
      <span>Datos personales</span>
      <span class="step-num">01 / 03</span>
    </div>
    <p class="card-subtitle">Tu nombre y fecha de nacimiento permiten calcular tu n√∫mero de vida y personalizar la lectura.</p>
    <div class="field">
      <label>Nombre completo</label>
      <input type="text" id="nombre" placeholder="Tu nombre y apellido" autocomplete="off"/>
    </div>
    <div class="row-2">
      <div class="field">
        <label>Fecha de nacimiento</label>
        <input type="date" id="fecha"/>
      </div>
      <div class="field">
        <label>Tipo de mazo</label>
        <select id="mazo">
          <option value="tarot">Tarot</option>
          <option value="oraculo">Cartas del Or√°culo</option>
          <option value="baraja">Baraja Espa√±ola</option>
          <option value="mixto" selected>Identificar autom√°ticamente</option>
        </select>
      </div>
    </div>
    <div class="btn-row" style="margin-top:8px">
      <button class="btn btn-primary" onclick="goStep2()">Continuar ‚Üí</button>
    </div>
  </div>

  <!-- STEP 2 -->
  <div class="card" id="step2" style="display:none">
    <div class="card-title">
      <span>Tu pregunta</span>
      <span class="step-num">02 / 03</span>
    </div>
    <p class="card-subtitle">Formula con claridad lo que deseas saber. Cuanto m√°s espec√≠fica sea tu pregunta, m√°s precisa ser√° la interpretaci√≥n.</p>
    <div class="field">
      <label>¬øQu√© quieres consultar?</label>
      <textarea id="pregunta" placeholder="Ej: ¬øQu√© me espera en el amor durante los pr√≥ximos meses? ¬øDebo cambiar de trabajo?"></textarea>
    </div>
    <div class="btn-row">
      <button class="btn btn-ghost" onclick="goStep1()">‚Üê</button>
      <button class="btn btn-primary" onclick="goStep3()">Continuar ‚Üí</button>
    </div>
  </div>

  <!-- STEP 3 -->
  <div class="card" id="step3" style="display:none">
    <div class="card-title">
      <span>Fotograf√≠a tus cartas</span>
      <span class="step-num">03 / 03</span>
    </div>
    <p class="card-subtitle">Coloca las cartas extendidas y bien iluminadas. La IA identificar√° cada carta autom√°ticamente.</p>

    <div class="photo-zone" id="photoZone">
      <input type="file" id="photoInput" accept="image/*" capture="environment" onchange="handlePhoto(event)"/>
      <div id="photoPlaceholder">
        <div class="photo-icon">‚ú¶</div>
        <div class="photo-text">
          <strong>Sube o toma una foto</strong>
          Aseg√∫rate de que las cartas est√©n visibles y bien iluminadas
        </div>
        <button class="camera-btn" onclick="document.getElementById('photoInput').click(); event.stopPropagation();">
          üì∑ Abrir c√°mara / galer√≠a
        </button>
      </div>
      <img id="preview-img" alt="Cartas"/>
      <div class="photo-overlay" id="photoOverlay">
        <span>Toca para cambiar la foto</span>
      </div>
    </div>

    <div class="cards-detected" id="cardsDetected">
      <div class="section-label">Cartas detectadas en la imagen</div>
      <div class="card-chips" id="cardChips"></div>
    </div>

    <div class="analyzing-state" id="analyzingState">
      <div class="orb"></div>
      <div class="analyzing-text">Consultando el or√°culo‚Ä¶</div>
      <div class="analyzing-sub" id="analyzingSubtext">Identificando cartas en la imagen</div>
    </div>

    <div class="error-box" id="errorBox"></div>

    <div class="btn-row" id="step3Btns">
      <button class="btn btn-ghost" onclick="goStep2()">‚Üê</button>
      <button class="btn btn-primary" id="readBtn" onclick="iniciarLectura()" disabled>
        ‚ú¶ Revelar interpretaci√≥n
      </button>
    </div>
  </div>

  <!-- RESULT -->
  <div class="result-card" id="resultCard">
    <div class="result-header">
      <div class="result-symbol">‚òΩ</div>
      <div class="result-meta">
        <div class="result-name" id="resNombre"></div>
        <div class="result-question" id="resPregunta"></div>
      </div>
    </div>
    <div class="result-body">
      <div class="result-cards-row" id="resCartas"></div>
      <div class="result-divider"></div>
      <div class="interpretation" id="resInterpretacion"></div>
    </div>
    <div class="result-footer">
      <span class="numerology-tag" id="resNumerologia"></span>
      <button class="btn btn-ghost" style="width:auto;padding:10px 20px;font-size:0.75rem" onclick="resetApp()">
        Nueva consulta
      </button>
    </div>
  </div>

</div>

<script>
  // ‚îÄ‚îÄ IMPORTANTE: esta URL apunta a tu Netlify Function ‚îÄ‚îÄ
  const API_URL = "/api/claude";

  let state = {
    nombre:'', fecha:'', mazo:'mixto', pregunta:'',
    imageBase64:null, imageType:null, detectedCards:[]
  };

  function goStep1() { show('step1'); hide('step2'); hide('step3'); setProgress(1); }

  function goStep2() {
    const n = document.getElementById('nombre').value.trim();
    const f = document.getElementById('fecha').value;
    if (!n) { alert('Por favor ingresa tu nombre.'); return; }
    if (!f) { alert('Por favor ingresa tu fecha de nacimiento.'); return; }
    state.nombre = n; state.fecha = f;
    state.mazo = document.getElementById('mazo').value;
    hide('step1'); show('step2'); hide('step3'); setProgress(2);
  }

  function goStep3() {
    const p = document.getElementById('pregunta').value.trim();
    if (!p) { alert('Por favor escribe tu pregunta.'); return; }
    state.pregunta = p;
    hide('step1'); hide('step2'); show('step3'); setProgress(3);
  }

  function show(id) { document.getElementById(id).style.display = 'block'; }
  function hide(id) { document.getElementById(id).style.display = 'none'; }

  function setProgress(step) {
    for (let i=1;i<=4;i++) {
      const dot = document.getElementById('dot'+i);
      if (!dot) continue;
      dot.classList.remove('active','done');
      if (i<step) dot.classList.add('done');
      else if (i===step) dot.classList.add('active');
    }
    for (let i=1;i<=3;i++) {
      const line = document.getElementById('line'+i);
      if (!line) continue;
      line.classList.toggle('done', i<step);
    }
  }

  // Comprime imagen a m√°ximo 1200px, calidad 0.82 para no superar l√≠mites de la API
  function compressImage(file, callback) {
    const reader = new FileReader();
    reader.onload = function(ev) {
      const img = new Image();
      img.onload = function() {
        const MAX = 1200;
        let w = img.width, h = img.height;
        if (w > MAX || h > MAX) {
          if (w > h) { h = Math.round(h * MAX / w); w = MAX; }
          else       { w = Math.round(w * MAX / h); h = MAX; }
        }
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        const dataURL = canvas.toDataURL('image/jpeg', 0.82);
        callback(dataURL);
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  }

  function handlePhoto(e) {
    const file = e.target.files[0];
    if (!file) return;
    compressImage(file, function(dataURL) {
      const preview = document.getElementById('preview-img');
      preview.src = dataURL; preview.style.display = 'block';
      document.getElementById('photoPlaceholder').style.display = 'none';
      document.getElementById('photoOverlay').style.display = 'flex';
      document.getElementById('photoZone').classList.add('has-image');
      state.imageType = 'image/jpeg';
      state.imageBase64 = dataURL.split(',')[1];
      detectCards();
    });
  }

  async function detectCards() {
    const analyzing = document.getElementById('analyzingState');
    const btns = document.getElementById('step3Btns');
    const detected = document.getElementById('cardsDetected');
    const errorBox = document.getElementById('errorBox');

    analyzing.style.display = 'block';
    btns.style.display = 'none';
    detected.style.display = 'none';
    errorBox.style.display = 'none';
    document.getElementById('analyzingSubtext').textContent = 'Identificando cartas en la imagen‚Ä¶';

    try {
      const mazoDesc = { tarot:'tarot (arcanos mayores y menores)', oraculo:'cartas del or√°culo', baraja:'baraja espa√±ola', mixto:'cualquier tipo de cartas' }[state.mazo];

      const response = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "claude-sonnet-4-5-20250929",
          max_tokens: 1000,
          messages: [{
            role: "user",
            content: [
              { type:"image", source:{ type:"base64", media_type: state.imageType||"image/jpeg", data: state.imageBase64 } },
              { type:"text", text:`Analiza esta imagen y detecta qu√© cartas son visibles. Pueden ser cartas de ${mazoDesc}.\n\nResponde √öNICAMENTE con un JSON v√°lido:\n{\n  "cartas": [\n    { "nombre": "Nombre de la carta", "tipo": "tarot|oraculo|baraja|desconocido", "posicion": "normal|invertida" }\n  ],\n  "cantidad": 1,\n  "notas": ""\n}\n\nSi no puedes ver cartas, retorna: { "cartas": [], "cantidad": 0, "notas": "No se detectaron cartas" }\nSolo JSON, sin markdown.` }
            ]
          }]
        })
      });

      const data = await response.json();

      if (data.error) throw new Error(data.error);

      const raw = data.content?.map(c => c.text||'').join('');
      const clean = raw.replace(/```json|```/g,'').trim();
      const parsed = JSON.parse(clean);
      state.detectedCards = parsed.cartas || [];

      const chips = document.getElementById('cardChips');
      chips.innerHTML = '';
      if (state.detectedCards.length === 0) {
        chips.innerHTML = '<span style="font-size:0.78rem;color:var(--text-dim)">No se detectaron cartas claramente. Puedes continuar igualmente.</span>';
      } else {
        state.detectedCards.forEach((c,i) => {
          const chip = document.createElement('div');
          chip.className = 'chip';
          chip.style.animationDelay = (i*0.07)+'s';
          chip.innerHTML = `${c.nombre}${c.posicion==='invertida'?' ‚Üì':''} <span>${c.tipo}</span>`;
          chips.appendChild(chip);
        });
      }

      detected.style.display = 'block';
      analyzing.style.display = 'none';
      btns.style.display = 'flex';
      document.getElementById('readBtn').disabled = false;

    } catch(err) {
      analyzing.style.display = 'none';
      btns.style.display = 'flex';
      errorBox.style.display = 'block';
      errorBox.textContent = '‚ö† Error al detectar cartas: ' + err.message + '. Puedes continuar igualmente.';
      document.getElementById('readBtn').disabled = false;
      state.detectedCards = [];
    }
  }

  function calcNumerologia(fechaStr) {
    const digits = fechaStr.replace(/-/g,'').split('').map(Number);
    let sum = digits.reduce((a,b)=>a+b,0);
    while (sum>9 && sum!==11 && sum!==22 && sum!==33) {
      sum = String(sum).split('').map(Number).reduce((a,b)=>a+b,0);
    }
    return sum;
  }

  async function iniciarLectura() {
    const btn = document.getElementById('readBtn');
    const analyzing = document.getElementById('analyzingState');
    const btns = document.getElementById('step3Btns');
    const errorBox = document.getElementById('errorBox');

    btn.disabled = true;
    btns.style.display = 'none';
    analyzing.style.display = 'block';
    errorBox.style.display = 'none';
    document.getElementById('analyzingSubtext').textContent = 'Tejiendo la interpretaci√≥n para ti‚Ä¶';

    const numVida = calcNumerologia(state.fecha);
    const cartasStr = state.detectedCards.length > 0
      ? state.detectedCards.map(c=>`${c.nombre} (${c.tipo}${c.posicion==='invertida'?', invertida':''})`).join(', ')
      : 'cartas visibles en la imagen adjunta';

    const fechaFormateada = new Date(state.fecha+'T12:00:00').toLocaleDateString('es-ES',{day:'numeric',month:'long',year:'numeric'});

    const systemPrompt = `Eres un or√°culo sabio y po√©tico especializado en la interpretaci√≥n de cartas de tarot, or√°culo y baraja espa√±ola. Tu estilo es evocador, profundo y c√°lido. Usas met√°foras hermosas pero mantienes claridad. No inventas predicciones absolutas; gu√≠as con sabidur√≠a. Siempre responde en espa√±ol.`;

    const userPrompt = `Realiza una lectura de cartas personalizada para:\n\n**Consultante:** ${state.nombre}\n**Fecha de nacimiento:** ${fechaFormateada}\n**N√∫mero de vida numerol√≥gico:** ${numVida}\n**Pregunta:** "${state.pregunta}"\n**Tipo de mazo:** ${state.mazo}\n**Cartas presentes:** ${cartasStr}\n\n${state.detectedCards.length===0?'IMPORTANTE: Analiza la imagen adjunta e interpreta las cartas que veas.':''}\n\nEscribe en p√°rrafos fluidos sin t√≠tulos:\n1. Frase po√©tica de apertura (2-3 l√≠neas)\n2. Interpretaci√≥n de las cartas en relaci√≥n a la pregunta (5-8 l√≠neas)\n3. El mensaje clave que las cartas revelan (2-3 l√≠neas)\n4. Consejo final basado en el n√∫mero de vida ${numVida} (2-3 l√≠neas)\n\nTono: m√≠stico pero cercano, esperanzador pero honesto. M√°ximo 220 palabras.`;

    try {
      const content = state.imageBase64
        ? [{ type:"image", source:{ type:"base64", media_type: state.imageType||"image/jpeg", data: state.imageBase64 } }, { type:"text", text: userPrompt }]
        : [{ type:"text", text: userPrompt }];

      const response = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "claude-sonnet-4-5-20250929",
          max_tokens: 1000,
          system: systemPrompt,
          messages: [{ role:"user", content }]
        })
      });

      const data = await response.json();

      // Capturar errores espec√≠ficos de la API
      if (data.error) {
        throw new Error(data.error);
      }

      const texto = data.content?.map(c=>c.text||'').join('').trim();
      if (!texto) throw new Error('La API respondi√≥ vac√≠o. Verifica tu API key en Netlify.');
      showResult(texto, numVida);

    } catch(err) {
      analyzing.style.display = 'none';
      btns.style.display = 'flex';
      btn.disabled = false;
      errorBox.style.display = 'block';
      errorBox.innerHTML = '‚ö† <strong>Error:</strong> ' + err.message + '<br><small>Revisa: 1) Que la variable ANTHROPIC_API_KEY est√© en Netlify ‚Üí Environment variables. 2) Que tu API key tenga cr√©ditos en console.anthropic.com</small>';
    }
  }

  function showResult(interpretacion, numVida) {
    document.getElementById('analyzingState').style.display = 'none';
    document.getElementById('resNombre').textContent = state.nombre;
    document.getElementById('resPregunta').textContent = '¬´' + state.pregunta + '¬ª';

    const cartasRow = document.getElementById('resCartas');
    cartasRow.innerHTML = '';
    state.detectedCards.forEach(c => {
      const chip = document.createElement('div');
      chip.className = 'result-chip';
      chip.textContent = c.nombre + (c.posicion==='invertida'?' ‚Üì':'');
      cartasRow.appendChild(chip);
    });

    document.getElementById('resInterpretacion').textContent = interpretacion;
    const fechaFormateada = new Date(state.fecha+'T12:00:00').toLocaleDateString('es-ES',{day:'numeric',month:'long',year:'numeric'});
    document.getElementById('resNumerologia').textContent = `N√∫mero de vida: ${numVida}  ¬∑  ${fechaFormateada}`;

    hide('step3');
    document.getElementById('resultCard').style.display = 'block';
    setTimeout(()=>{ document.getElementById('resultCard').scrollIntoView({behavior:'smooth',block:'start'}); }, 100);
    setProgress(4);
  }

  function resetApp() {
    state = { nombre:'',fecha:'',mazo:'mixto',pregunta:'',imageBase64:null,imageType:null,detectedCards:[] };
    document.getElementById('nombre').value = '';
    document.getElementById('fecha').value = '';
    document.getElementById('pregunta').value = '';
    document.getElementById('preview-img').style.display = 'none';
    document.getElementById('preview-img').src = '';
    document.getElementById('photoPlaceholder').style.display = 'block';
    document.getElementById('photoOverlay').style.display = 'none';
    document.getElementById('photoZone').classList.remove('has-image');
    document.getElementById('cardsDetected').style.display = 'none';
    document.getElementById('analyzingState').style.display = 'none';
    document.getElementById('step3Btns').style.display = 'flex';
    document.getElementById('readBtn').disabled = true;
    document.getElementById('errorBox').style.display = 'none';
    document.getElementById('resultCard').style.display = 'none';
    document.getElementById('photoInput').value = '';
    goStep1();
    window.scrollTo({top:0,behavior:'smooth'});
  }
</script>
</body>
</html>
